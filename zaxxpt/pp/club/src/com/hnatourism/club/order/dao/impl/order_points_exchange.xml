<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="orderPointsExchange">
	<typeAlias alias="orderPointsExchange" type="com.hnatourism.club.order.domain.OrderPointsExchange" />
	<resultMap id="orderPointsExchangeResultMap" class="orderPointsExchange">
		<result column="CREATE_USER" property="createUser" />
		<result column="CREATE_TIME" property="createTime" />
		<result column="UPDATE_USER" property="updateUser" />
		<result column="UPDATE_TIME" property="updateTime" />
		<result column="ID" property="id" />
		<result column="CODE" property="code" />
		<result column="OWNER" property="owner" />
		<result column="POINTS" property="points" />
		<result column="PRICE" property="price" />
		<result column="CONTACT" property="contact" />
		<result column="STS" property="sts" />
		<result column="PURCHASER" property="purchaser" />
		<result column="CONVERSION_TIME" property="conversionTime" />
		<result column="OPERATE_STS" property="operateSts" />
		<result column="ORGANIZATION_ID" property="organizationId" />
		<result column="EXPIREDDAY" property="expiredDay"/>
	</resultMap>
	<sql id="selectOrderPointsExchangeSql">
		<![CDATA[
			SELECT T.EXPIREDDAY,T.CREATE_USER,T.CREATE_TIME,T.UPDATE_USER,T.UPDATE_TIME,T.ID,T.CODE,T.OWNER,T.POINTS,T.PRICE,T.CONTACT,T.STS,T.PURCHASER,T.CONVERSION_TIME,T.OPERATE_STS,T.ORGANIZATION_ID 
			FROM ORDER_POINTS_EXCHANGE T
		]]>
	</sql>
	<select id="findOrderPointsExchangeByWhere" parameterClass="orderPointsExchange" resultMap="orderPointsExchangeResultMap">
		<include refid="selectOrderPointsExchangeSql"/>	
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="createUser">
				T.CREATE_USER=#createUser#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="createTime">
				T.CREATE_TIME=#createTime#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="updateUser">
				T.UPDATE_USER=#updateUser#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="updateTime">
				T.UPDATE_TIME=#updateTime#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="code">
				T.CODE=#code#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="owner">
				T.OWNER=#owner#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="points">
				T.POINTS=#points#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="price">
				T.PRICE=#price#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="contact">
				T.CONTACT=#contact#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="sts">
				T.STS=#sts#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="purchaser">
				T.PURCHASER=#purchaser#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="conversionTime">
				T.CONVERSION_TIME=#conversionTime#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="operateSts">
				T.OPERATE_STS=#operateSts#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="organizationId">
				T.ORGANIZATION_ID=#organizationId#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="expiredDay">
				T.EXPIREDDAY=#expiredDay#
			</isNotEmpty>
			<![CDATA[
			order by T.CREATE_TIME DESC
		]]>
		</dynamic>
	</select>
	<select id="findOrderPointsExchangeById" parameterClass="java.lang.String" resultMap="orderPointsExchangeResultMap">
		<include refid="selectOrderPointsExchangeSql"/>	
		<![CDATA[
			where T.id=#id#
		]]>
	</select>
	<insert id="insertOrderPointsExchange" parameterClass="orderPointsExchange">
		INSERT INTO ORDER_POINTS_EXCHANGE
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="createUser">
				CREATE_USER
			</isNotEmpty>

			<isNotEmpty prepend="," property="createTime">
				CREATE_TIME
			</isNotEmpty>

			<isNotEmpty prepend="," property="updateUser">
				UPDATE_USER
			</isNotEmpty>

			<isNotEmpty prepend="," property="updateTime">
				UPDATE_TIME
			</isNotEmpty>

			<isNotEmpty prepend="," property="id">
				ID
			</isNotEmpty>

			<isNotEmpty prepend="," property="code">
				CODE
			</isNotEmpty>

			<isNotEmpty prepend="," property="owner">
				OWNER
			</isNotEmpty>

			<isNotEmpty prepend="," property="points">
				POINTS
			</isNotEmpty>

			<isNotEmpty prepend="," property="price">
				PRICE
			</isNotEmpty>

			<isNotEmpty prepend="," property="contact">
				CONTACT
			</isNotEmpty>

			<isNotEmpty prepend="," property="sts">
				STS
			</isNotEmpty>

			<isNotEmpty prepend="," property="purchaser">
				PURCHASER
			</isNotEmpty>

			<isNotEmpty prepend="," property="conversionTime">
				CONVERSION_TIME
			</isNotEmpty>

			<isNotEmpty prepend="," property="operateSts">
				OPERATE_STS
			</isNotEmpty>

			<isNotEmpty prepend="," property="organizationId">
				ORGANIZATION_ID
			</isNotEmpty> 

             <isNotEmpty prepend="," property="expiredDay">
				EXPIREDDAY
			</isNotEmpty>
		</dynamic>		
		<dynamic prepend=") VALUES (">

			<isNotEmpty prepend="," property="createUser">
				#createUser#
			</isNotEmpty>


			<isNotEmpty prepend="," property="createTime">
				#createTime#
			</isNotEmpty>


			<isNotEmpty prepend="," property="updateUser">
				#updateUser#
			</isNotEmpty>


			<isNotEmpty prepend="," property="updateTime">
				#updateTime#
			</isNotEmpty>


			<isNotEmpty prepend="," property="id">
				#id#
			</isNotEmpty>


			<isNotEmpty prepend="," property="code">
				#code#
			</isNotEmpty>


			<isNotEmpty prepend="," property="owner">
				#owner#
			</isNotEmpty>


			<isNotEmpty prepend="," property="points">
				#points#
			</isNotEmpty>


			<isNotEmpty prepend="," property="price">
				#price#
			</isNotEmpty>


			<isNotEmpty prepend="," property="contact">
				#contact#
			</isNotEmpty>


			<isNotEmpty prepend="," property="sts">
				#sts#
			</isNotEmpty>


			<isNotEmpty prepend="," property="purchaser">
				#purchaser#
			</isNotEmpty>


			<isNotEmpty prepend="," property="conversionTime">
				#conversionTime#
			</isNotEmpty>


			<isNotEmpty prepend="," property="operateSts">
				#operateSts#
			</isNotEmpty>


			<isNotEmpty prepend="," property="organizationId">
				#organizationId#
			</isNotEmpty>
			<isNotEmpty prepend="," property="expiredDay">
				#expiredDay#
			</isNotEmpty>
		 </dynamic>	)
	</insert>
	
	<update id="updateOrderPointsExchange" parameterClass="orderPointsExchange">
		UPDATE ORDER_POINTS_EXCHANGE
        <dynamic prepend="set">
		   <isNotEmpty prepend="," property="createUser">
              CREATE_USER=#createUser#
           </isNotEmpty>
		   <isNotEmpty prepend="," property="createTime">
              CREATE_TIME=#createTime#
           </isNotEmpty>
		   <isNotEmpty prepend="," property="updateUser">
              UPDATE_USER=#updateUser#
           </isNotEmpty>
		   <isNotEmpty prepend="," property="updateTime">
              UPDATE_TIME=#updateTime#
           </isNotEmpty>
		   <isNotEmpty prepend="," property="code">
              CODE=#code#
           </isNotEmpty>
		   <isNotEmpty prepend="," property="owner">
              OWNER=#owner#
           </isNotEmpty>
		   <isNotEmpty prepend="," property="points">
              POINTS=#points#
           </isNotEmpty>
		   <isNotEmpty prepend="," property="price">
              PRICE=#price#
           </isNotEmpty>
		   <isNotEmpty prepend="," property="contact">
              CONTACT=#contact#
           </isNotEmpty>
		   <isNotEmpty prepend="," property="sts">
              STS=#sts#
           </isNotEmpty>
		   <isNotEmpty prepend="," property="purchaser">
              PURCHASER=#purchaser#
           </isNotEmpty>
		   <isNotEmpty prepend="," property="conversionTime">
              CONVERSION_TIME=#conversionTime#
           </isNotEmpty>
		   <isNotEmpty prepend="," property="operateSts">
              OPERATE_STS=#operateSts#
           </isNotEmpty>
		   <isNotEmpty prepend="," property="organizationId">
              ORGANIZATION_ID=#organizationId#
           </isNotEmpty>
           <isNotEmpty prepend="," property="expiredDay">
				EXPIRED=#expiredDay#
			</isNotEmpty>
        </dynamic>
		WHERE 
               ID=#id#
	</update>	
	<delete id="deleteOrderPointsExchange" parameterClass="java.lang.String">
		DELETE FROM ORDER_POINTS_EXCHANGE
		WHERE 
               ID=#id#
	</delete>	
	
	<!-- 总积分 -->
	<select id="findCountPointByUserAccount" parameterClass="java.lang.String" resultClass="java.lang.Double">
		select sum(amount) from order_bill where account=#account# and (prod_type='p' or prod_type='P') and transaction_type=1
	</select>
	<!-- 消费使用积分 -->
	<select id="findConsumerPointNMByUserAccount" parameterClass="java.lang.String" resultClass="java.lang.Double">
		select sum(t.amount)  from order_bill t where t.account=#account# and t.status='01'  and 
		(t.order_id in (select t1.id from order_glof t1) or 
		t.order_id in (select t2.id from order_golf_exception  t2 where t2.type='M' or t2.type='m') or 
		t.order_id in (select t3.id from order_lounge t3) or 
		t.order_id in (select t4.id from order_lounge_exception  t4 where t4.type='M' or t4.type='m') or  
		(t.prod_type='H' and t.order_type='N') or (t.prod_type='F' and t.order_type='N'))
	</select>
	<!-- 消费退款返回积分 -->
	<select id="findConsumerRPointByUserAccount" parameterClass="java.lang.String" resultClass="java.lang.Double">
		select sum(t.amount)  from order_bill t where t.account=#account# and 
		(t.order_id in (select t2.id from order_golf_exception  t2 where t2.type='R' or t2.type='r') or 
		t.order_id in (select t4.id from order_lounge_exception  t4 where t4.type='R' or t4.type='r') or
		(t.prod_type='H' and t.order_type='E') or (t.prod_type='F' and t.order_type='E'))  
	</select>
	<!-- 当前正在交易积分 -->
	<select id="findC_T_PointByUserAccount" parameterClass="java.lang.String" resultClass="java.lang.Double">
		select sum(points) from ORDER_POINTS_EXCHANGE where owner=#account# and (sts=1 or sts=4)
	</select>
</sqlMap>